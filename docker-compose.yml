services:
  hive-metastore-db:
    container_name: hive-metastore-db
    hostname: hive-metastore-db
    image: mysql:latest
    environment:
      MYSQL_ROOT_PASSWORD: ${HIVE_METASTORE_DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${HIVE_METASTORE_DB_NAME}
      MYSQL_USER: ${HIVE_METASTORE_DB_USER}
      MYSQL_PASSWORD: ${HIVE_METASTORE_DB_PASSWORD}
    volumes:
      - hive-metastore-db-data:/var/lib/mysql
    networks:
      internal:
        ipv4_address: ${HIVE_METASTORE_DB_IP}
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      interval: 10s
      retries: 5
      timeout: 5s
    profiles: [hive]

  hive-server:
    container_name: hive-server
    hostname: hive-server
    build:
      context: ./hive
      dockerfile: Dockerfile
      args:
        - HIVE_VERSION=${HIVE_VERSION}
        - HADOOP_VERSION=${HADOOP_VERSION}
    depends_on:
      hive-metastore-db:
        condition: service_healthy
    environment:
      - HADOOP_HOME=/opt/hadoop
      - HIVE_HOME=/opt/hive
    volumes:
      - ./secrets/gcp-sa.json:/opt/gcp/secrets/service-account.json
      - ./hive/hive-site.xml:/opt/hive/conf/hive-site.xml
      - ./hive/core-site.xml:/opt/hadoop/etc/hadoop/core-site.xml
    networks:
      internal:
        ipv4_address: ${HIVE_SERVER_IP}
    healthcheck:
      test: ['CMD-SHELL', 'nc -zv localhost 9083 || exit 1']
      interval: 10s
      retries: 5
      timeout: 5s
    profiles: [hive]

  trino-event-db:
    container_name: trino-event-db
    hostname: trino-event-db
    image: mysql:latest
    environment:
      MYSQL_ROOT_PASSWORD: ${TRINO_EVENT_DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${TRINO_EVENT_DB_NAME}
      MYSQL_USER: ${TRINO_EVENT_DB_USER}
      MYSQL_PASSWORD: ${TRINO_EVENT_DB_PASSWORD}
    volumes:
      - trino-event-db-data:/var/lib/mysql
    networks:
      internal:
        ipv4_address: ${TRINO_EVENT_DB_IP}
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
      interval: 10s
      retries: 5
      timeout: 5s
    profiles: [trino]

  trino-coordinator:
    hostname: trino-coordinator
    container_name: trino-coordinator
    build:
      context: ./trino
      dockerfile: Dockerfile
    ports:
      - '8080:8080'
      - '9080:9080'
      - '9081:9081'
      - '12345:12345'
    volumes:
      - ./trino/coordinator/config.properties:/etc/trino/config.properties
      - ./trino/coordinator/jvm.config:/etc/trino/jvm.config
      - ./trino/coordinator/jmx-config.yaml:/etc/trino/jmx/config.yaml
      - ./trino/coordinator/mysql-event-listener.properties:/etc/trino/mysql-event-listener.properties
      - ./secrets/gcp-sa.json:/opt/gcp/secrets/service-account.json
      - ./trino/catalog:/etc/trino/catalog
      - ./trino/common/exchange-manager.properties:/etc/trino/exchange-manager.properties
    deploy:
      restart_policy:
        condition: on-failure
        max_attempts: 3
    depends_on:
      trino-event-db:
        condition: service_healthy
      hive-server:
        condition: service_healthy
    networks:
      - internal
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/v1/info']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 90s
    profiles: [trino]

  trino-worker:
    build:
      context: ./trino
      dockerfile: Dockerfile
    volumes:
      - ./trino/worker/config.properties:/etc/trino/config.properties
      - ./secrets/gcp-sa.json:/opt/gcp/secrets/service-account.json
      - ./trino/catalog:/etc/trino/catalog
      - ./trino/common/exchange-manager.properties:/etc/trino/exchange-manager.properties
    depends_on:
      trino-event-db:
        condition: service_healthy
      hive-server:
        condition: service_healthy
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        max_attempts: 3
    networks:
      - internal
    profiles: [trino]

  superser-backend-db:
    container_name: superser-backend-db
    hostname: superser-backend-db
    image: postgres:latest
    environment:
      POSTGRES_USER: ${SUPERSET_BACKEND_DB_USER}
      POSTGRES_PASSWORD: ${SUPERSET_BACKEND_DB_PASSWORD}
      POSTGRES_DB: ${SUPERSET_BACKEND_DB_NAME}
    volumes:
      - superser-backend-db-data:/var/lib/postgresql/data
    networks:
      internal:
        ipv4_address: ${SUPERSET_BACKEND_DB_IP}
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', '${SUPERSET_BACKEND_DB_USER}']
      interval: 10s
      retries: 5
      timeout: 5s
    profiles: [superset]

  superset:
    container_name: superset
    hostname: superset
    build:
      context: ./superset
      dockerfile: Dockerfile
    depends_on:
      superser-backend-db:
        condition: service_healthy
    environment:
      - SUPERSET_SECRET_KEY=${SUPERSET_SECRET_KEY}
      - SUPERSET_CONFIG_PATH=/app/superset_config.py
    volumes:
      - ./superset/superset_config.py:/app/superset_config.py
    ports:
      - '8088:8088'
    networks:
      - www
      - internal
    profiles: [superset]

  superset-init:
    container_name: superset-init
    hostname: superset-init
    build:
      context: ./superset
      dockerfile: Dockerfile
    command: ' /opt/bin/docker-init.sh'
    depends_on:
      superser-backend-db:
        condition: service_healthy
    environment:
      - SUPERSET_SECRET_KEY=${SUPERSET_SECRET_KEY}
      - SUPERSET_CONFIG_PATH=/app/superset_config.py
    volumes:
      - ./superset/superset_config.py:/app/superset_config.py
    networks:
      - internal
    profiles: [superset]

volumes:
  trino-event-db-data:
  hive-metastore-db-data:
  superser-backend-db-data:

networks:
  internal:
    ipam:
      driver: default
      config:
        - subnet: ${INTERNAL_SUBNET}
  www:
